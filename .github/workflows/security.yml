name: Security & Quality Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
  schedule:
    # Weekly security scan (Sundays at midnight UTC)
    - cron: '0 0 * * 0'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # Job 1: SAST - GitHub CodeQL Analysis
  # ============================================================================
  codeql-analysis:
    name: Static Analysis (CodeQL)
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Protocol Buffers compiler
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: rust
          config-file: ./.github/codeql/codeql-config.yml
          queries: security-extended

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:rust"

  # ============================================================================
  # Job 2: Security-Specific Code Quality Checks
  # ============================================================================
  code-quality-checks:
    name: Security Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect unsafe blocks
        id: unsafe-check
        run: |
          echo "Scanning for unsafe blocks..."
          UNSAFE_COUNT=$(grep -r "unsafe" --include="*.rs" src/ | grep -v "// SAFETY:" | wc -l || echo "0")
          echo "unsafe_count=$UNSAFE_COUNT" >> $GITHUB_OUTPUT
          echo "Found $UNSAFE_COUNT unsafe blocks without SAFETY comments"

          if [ "$UNSAFE_COUNT" -gt 0 ]; then
            echo "::warning::Found $UNSAFE_COUNT unsafe blocks without SAFETY comments"
            grep -rn "unsafe" --include="*.rs" src/ | grep -v "// SAFETY:" || true
          fi

      - name: Check for prohibited dependencies
        run: |
          echo "Checking for prohibited dependencies..."
          # presage-store-sqlite is allowed through StromaStore wrapper
          # Verify StromaStore wrapper exists if presage-store-sqlite is used
          if grep -qE '^\s*presage-store-sqlite\s*=' Cargo.toml; then
            if ! grep -rq "StromaStore" --include="*.rs" src/; then
              echo "::error::presage-store-sqlite requires StromaStore wrapper - see security-constraints.bead Â§10"
              exit 1
            fi
            echo "âœ“ presage-store-sqlite properly wrapped by StromaStore"
          fi
          echo "âœ“ No prohibited dependencies found"

      - name: Upload unsafe block report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unsafe-blocks-report
          path: |
            unsafe-blocks.txt
          retention-days: 30

  # ============================================================================
  # Job 3: Binary Size Monitoring
  # ============================================================================
  binary-size:
    name: Binary Size Monitor
    runs-on: ubuntu-latest
    container:
      image: rust:1.93-alpine
    steps:
      - name: Install system dependencies
        run: |
          apk add --no-cache musl-dev pkgconfig openssl-dev openssl-libs-static git \
            clang18-static llvm18-dev protoc

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build release binary (musl)
        env:
          LIBCLANG_STATIC_PATH: /usr/lib/llvm18/lib
          LLVM_CONFIG_PATH: /usr/lib/llvm18/bin/llvm-config
        run: cargo build --release --target x86_64-unknown-linux-musl --bin stroma

      - name: Measure binary size
        id: size-check
        run: |
          BINARY_SIZE=$(stat -c%s "target/x86_64-unknown-linux-musl/release/stroma" || echo "0")
          echo "binary_size=$BINARY_SIZE" >> $GITHUB_OUTPUT
          echo "Binary size: $(numfmt --to=iec-i --suffix=B $BINARY_SIZE)"

          # Store baseline (if first run)
          mkdir -p .github/metrics
          if [ ! -f .github/metrics/binary-baseline.txt ]; then
            echo "$BINARY_SIZE" > .github/metrics/binary-baseline.txt
            echo "Baseline set: $BINARY_SIZE bytes"
          else
            BASELINE=$(cat .github/metrics/binary-baseline.txt)
            INCREASE=$((BINARY_SIZE - BASELINE))
            PERCENT=$(echo "scale=2; ($INCREASE / $BASELINE) * 100" | bc)

            echo "Baseline: $(numfmt --to=iec-i --suffix=B $BASELINE)"
            echo "Current: $(numfmt --to=iec-i --suffix=B $BINARY_SIZE)"
            echo "Change: $(numfmt --to=iec-i --suffix=B $INCREASE) ($PERCENT%)"

            if [ "$INCREASE" -gt 1048576 ] || (( $(echo "$PERCENT > 10" | bc -l) )); then
              echo "::error::Binary size increased by $(numfmt --to=iec-i --suffix=B $INCREASE) ($PERCENT%) - exceeds threshold"
              exit 1
            fi
          fi

      - name: Upload size report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: binary-size-report
          path: |
            .github/metrics/
          retention-days: 30
  # ============================================================================
  # Job 4: Security Constraints Verification
  # ============================================================================
  security-constraints:
    name: Security Constraints (Bead Compliance)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify no cleartext Signal IDs
        run: |
          echo "Checking for cleartext Signal ID violations..."
          # Search for patterns that might indicate cleartext Signal ID storage
          VIOLATIONS=$(grep -r "store.*signal.*id\|save.*signal.*id\|persist.*signal.*id" --include="*.rs" src/ | grep -v "// HMAC\|mask_identity\|Hash::" || echo "")

          if [ -n "$VIOLATIONS" ]; then
            echo "::error::Potential cleartext Signal ID storage detected:"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "âœ“ No cleartext Signal ID violations detected"

      - name: Verify zeroization usage
        run: |
          echo "Checking for zeroization on sensitive data..."
          # Ensure zeroize crate is used
          if ! grep -q "zeroize" Cargo.toml; then
            echo "::warning::zeroize crate not found in Cargo.toml"
          fi
          echo "âœ“ Zeroization check complete"

      - name: Verify StromaStore wrapper implementation
        run: |
          echo "Verifying StromaStore wrapper exists..."
          # presage-store-sqlite must be wrapped by StromaStore (encrypted, no message storage)
          if grep -qE '^\s*presage-store-sqlite\s*=' Cargo.toml; then
            if grep -rq "struct StromaStore" --include="*.rs" src/; then
              echo "âœ“ StromaStore wrapper implementation found"
              # Verify StromaStore does not directly store messages
              if grep -r "save_message\|store_message" --include="*.rs" src/ | grep -q StromaStore; then
                echo "::error::StromaStore must NOT implement message storage - see security-constraints.bead Â§10"
                exit 1
              fi
              echo "âœ“ StromaStore properly excludes message storage"
            else
              echo "::error::presage-store-sqlite requires StromaStore wrapper - see security-constraints.bead Â§10"
              exit 1
            fi
          else
            echo "âœ“ No presage-store-sqlite dependency found"
          fi

      - name: Check for grace period violations
        run: |
          echo "Checking for prohibited grace periods..."
          GRACE_VIOLATIONS=$(grep -r "grace.*period\|delay.*ejection\|warn.*before.*eject" --include="*.rs" src/ || echo "")

          if [ -n "$GRACE_VIOLATIONS" ]; then
            echo "::error::Grace period detected - prohibited by security-constraints.bead Â§2"
            echo "$GRACE_VIOLATIONS"
            exit 1
          fi
          echo "âœ“ No grace period violations detected"

  # ============================================================================
  # Job 5: Supply Chain Security
  # ============================================================================
  supply-chain:
    name: Supply Chain Security
    uses: ./.github/workflows/cargo-deny.yml

  # ============================================================================
  # Job 6: Protected Files Verification
  # ============================================================================
  protected-files-check:
    name: Protected Files Verification
    runs-on: ubuntu-latest
    # Only run on pull requests
    if: github.event_name == 'pull_request'

    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for diff

      - name: Check for protected file modifications
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## Protected Files Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Define protected file patterns
          PROTECTED_PATTERNS=(
            ".github/workflows/"
            ".github/actions/"
            ".github/codeql/codeql-config.yml"
            "deny.toml"
          )

          # Get base branch
          BASE_BRANCH="${{ github.base_ref }}"

          # Get list of changed files in this PR
          CHANGED_FILES=$(git diff --name-only origin/${BASE_BRANCH}...HEAD)

          echo "Changed files:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$CHANGED_FILES" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if any protected files were modified
          PROTECTED_FILES_MODIFIED=false
          PROTECTED_FILES_LIST=""

          for pattern in "${PROTECTED_PATTERNS[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "$pattern"; then
              echo "âš ï¸ Protected file pattern detected: $pattern" >> $GITHUB_STEP_SUMMARY
              PROTECTED_FILES_MODIFIED=true
              PROTECTED_FILES_LIST="$PROTECTED_FILES_LIST\n  - $pattern"
            fi
          done

          # If protected files modified, check for human approval
          if [ "$PROTECTED_FILES_MODIFIED" = true ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”’ **Protected CI/CD files were modified. Checking for human approval...**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Get PR body
            PR_BODY=$(gh pr view ${{ github.event.pull_request.number }} --json body -q .body)

            # Check for HUMAN_APPROVED tag
            if echo "$PR_BODY" | grep -q "HUMAN_APPROVED:"; then
              APPROVAL=$(echo "$PR_BODY" | grep "HUMAN_APPROVED:" | head -1)
              echo "âœ… **Human approval found:**" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$APPROVAL" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Protected files check: **PASSED** âœ…" >> $GITHUB_STEP_SUMMARY
              exit 0
            else
              echo "âŒ **ERROR: Protected CI/CD files modified without human approval**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Protected files changed in this PR:**$PROTECTED_FILES_LIST" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**To get approval:**" >> $GITHUB_STEP_SUMMARY
              echo "1. File issue: \`bd create --title='CI/CD: ...' --type=bug --priority=1\`" >> $GITHUB_STEP_SUMMARY
              echo "2. Request approval: \`gt mail send  mayor -s 'CI/CD Change Request: <id>'\`" >> $GITHUB_STEP_SUMMARY
              echo "3. Wait for human approval" >> $GITHUB_STEP_SUMMARY
              echo "4. Add to PR body: \`HUMAN_APPROVED: <approval-message-id>\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "See \`docs/CI-CD-PROTECTION.md\` for details" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "âœ… No protected files modified" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Protected files check: **PASSED** âœ…" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Job 7: Security Summary
  # ============================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, code-quality-checks, binary-size, security-constraints, supply-chain, protected-files-check]
    if: always()
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate summary
        run: |
          echo "## Security Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Static Analysis (CodeQL)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security Code Quality Checks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Binary Size Monitor" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security Constraints (Bead Compliance)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Supply Chain Security (cargo-deny)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Protected Files Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All security checks passed! âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Note: Standard checks (format, lint, tests, coverage) run in CI workflow" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **Security Pipeline Passed**\n\nAll security-specific checks completed successfully:\n- Static Analysis (CodeQL)\n- Security Code Quality Checks\n- Binary Size Monitoring\n- Security Constraints Compliance\n- Supply Chain Security (cargo-deny)\n- Protected Files Verification\n\n_Standard checks (format, lint, tests, coverage) verified in CI workflow_'
            })
