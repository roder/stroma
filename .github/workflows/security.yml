name: Security & Quality Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
  schedule:
    # Weekly security scan (Sundays at midnight UTC)
    - cron: '0 0 * * 0'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # Job 1: SAST - GitHub CodeQL Analysis
  # ============================================================================
  codeql-analysis:
    name: Static Analysis (CodeQL)
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Protocol Buffers compiler
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: rust
          config-file: ./.github/codeql/codeql-config.yml
          queries: security-extended

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:rust"

  # ============================================================================
  # Job 2: Security-Specific Code Quality Checks
  # ============================================================================
  code-quality-checks:
    name: Security Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect unsafe blocks
        id: unsafe-check
        run: |
          echo "Scanning for unsafe blocks..."
          UNSAFE_COUNT=$(grep -r "unsafe" --include="*.rs" src/ | grep -v "// SAFETY:" | wc -l || echo "0")
          echo "unsafe_count=$UNSAFE_COUNT" >> $GITHUB_OUTPUT
          echo "Found $UNSAFE_COUNT unsafe blocks without SAFETY comments"

          if [ "$UNSAFE_COUNT" -gt 0 ]; then
            echo "::warning::Found $UNSAFE_COUNT unsafe blocks without SAFETY comments"
            grep -rn "unsafe" --include="*.rs" src/ | grep -v "// SAFETY:" || true
          fi

      - name: Check for prohibited dependencies
        run: |
          echo "Checking for prohibited dependencies..."
          # Check for presage-store-sqlite (prohibited by security-constraints.bead)
          # Only check in dependencies sections, not comments
          if grep -E '^\s*(presage-store-sqlite)\s*=' Cargo.toml; then
            echo "::error::presage-store-sqlite is prohibited - must use custom StromaProtocolStore"
            exit 1
          fi
          echo "✓ No prohibited dependencies found"

      - name: Upload unsafe block report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unsafe-blocks-report
          path: |
            unsafe-blocks.txt
          retention-days: 30

  # ============================================================================
  # Job 3: Binary Size Monitoring
  # ============================================================================
  binary-size:
    name: Binary Size Monitor
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y musl-tools protobuf-compiler

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "security-binary-size"

      - name: Build release binary (musl)
        run: cargo build --release --target x86_64-unknown-linux-musl

      - name: Measure binary size
        id: size-check
        run: |
          BINARY_SIZE=$(stat -c%s "target/x86_64-unknown-linux-musl/release/stroma" || echo "0")
          echo "binary_size=$BINARY_SIZE" >> $GITHUB_OUTPUT
          echo "Binary size: $(numfmt --to=iec-i --suffix=B $BINARY_SIZE)"

          # Store baseline (if first run)
          mkdir -p .github/metrics
          if [ ! -f .github/metrics/binary-baseline.txt ]; then
            echo "$BINARY_SIZE" > .github/metrics/binary-baseline.txt
            echo "Baseline set: $BINARY_SIZE bytes"
          else
            BASELINE=$(cat .github/metrics/binary-baseline.txt)
            INCREASE=$((BINARY_SIZE - BASELINE))
            PERCENT=$(echo "scale=2; ($INCREASE / $BASELINE) * 100" | bc)

            echo "Baseline: $(numfmt --to=iec-i --suffix=B $BASELINE)"
            echo "Current: $(numfmt --to=iec-i --suffix=B $BINARY_SIZE)"
            echo "Change: $(numfmt --to=iec-i --suffix=B $INCREASE) ($PERCENT%)"

            # Fail if increase exceeds 10% or 1MB
            if [ "$INCREASE" -gt 1048576 ] || (( $(echo "$PERCENT > 10" | bc -l) )); then
              echo "::error::Binary size increased by $(numfmt --to=iec-i --suffix=B $INCREASE) ($PERCENT%) - exceeds threshold"
              exit 1
            fi
          fi

      - name: Upload size report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: binary-size-report
          path: |
            .github/metrics/
          retention-days: 30

  # ============================================================================
  # Job 4: Security Constraints Verification
  # ============================================================================
  security-constraints:
    name: Security Constraints (Bead Compliance)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify no cleartext Signal IDs
        run: |
          echo "Checking for cleartext Signal ID violations..."
          # Search for patterns that might indicate cleartext Signal ID storage
          VIOLATIONS=$(grep -r "store.*signal.*id\|save.*signal.*id\|persist.*signal.*id" --include="*.rs" src/ | grep -v "// HMAC\|mask_identity\|Hash::" || echo "")

          if [ -n "$VIOLATIONS" ]; then
            echo "::error::Potential cleartext Signal ID storage detected:"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "✓ No cleartext Signal ID violations detected"

      - name: Verify zeroization usage
        run: |
          echo "Checking for zeroization on sensitive data..."
          # Ensure zeroize crate is used
          if ! grep -q "zeroize" Cargo.toml; then
            echo "::warning::zeroize crate not found in Cargo.toml"
          fi
          echo "✓ Zeroization check complete"

      - name: Verify no presage-store-sqlite usage
        run: |
          echo "Checking for prohibited presage-store-sqlite..."
          # Check Cargo.toml for actual dependency (not comments)
          if grep -E '^\s*(presage-store-sqlite)\s*=' Cargo.toml; then
            echo "::error::presage-store-sqlite is prohibited - must use custom StromaProtocolStore per security-constraints.bead §10"
            exit 1
          fi
          # Check source files for SqliteStore usage
          if grep -r "SqliteStore" --include="*.rs" src/; then
            echo "::error::SqliteStore usage is prohibited - must use custom StromaProtocolStore per security-constraints.bead §10"
            exit 1
          fi
          echo "✓ No prohibited store usage detected"

      - name: Verify StromaProtocolStore implementation
        run: |
          echo "Verifying custom StromaProtocolStore exists..."
          if [ -f "src/store/stroma_protocol_store.rs" ] || grep -q "StromaProtocolStore" src/**/*.rs; then
            echo "✓ StromaProtocolStore implementation found"
          else
            echo "::warning::StromaProtocolStore implementation not found - required by security-constraints.bead"
          fi

      - name: Check for grace period violations
        run: |
          echo "Checking for prohibited grace periods..."
          GRACE_VIOLATIONS=$(grep -r "grace.*period\|delay.*ejection\|warn.*before.*eject" --include="*.rs" src/ || echo "")

          if [ -n "$GRACE_VIOLATIONS" ]; then
            echo "::error::Grace period detected - prohibited by security-constraints.bead §2"
            echo "$GRACE_VIOLATIONS"
            exit 1
          fi
          echo "✓ No grace period violations detected"

  # ============================================================================
  # Job 5: Supply Chain Security
  # ============================================================================
  supply-chain:
    name: Supply Chain Security
    uses: ./.github/workflows/cargo-deny.yml

  # ============================================================================
  # Job 6: Security Summary
  # ============================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, code-quality-checks, binary-size, security-constraints, supply-chain]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate summary
        run: |
          echo "## Security Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Static Analysis (CodeQL)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Security Code Quality Checks" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Binary Size Monitor" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Security Constraints (Bead Compliance)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Supply Chain Security (cargo-deny)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All security checks passed! ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Note: Standard checks (format, lint, tests, coverage) run in CI workflow" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ **Security Pipeline Passed**\n\nAll security-specific checks completed successfully:\n- Static Analysis (CodeQL)\n- Security Code Quality Checks\n- Binary Size Monitoring\n- Security Constraints Compliance\n- Supply Chain Security (cargo-deny)\n\n_Standard checks (format, lint, tests, coverage) verified in CI workflow_'
            })
