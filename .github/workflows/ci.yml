name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  # ============================================================================
  # Code Quality Checks
  # ============================================================================
  format-and-lint:
    name: Format & Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: ./.github/actions/rust-setup
        with:
          toolchain: stable
          components: rustfmt,clippy
          cache-key: ci-stable

      - name: Check formatting
        run: cargo fmt --check

      - name: Run Clippy
        run: cargo clippy --all-targets -- -D warnings

  # ============================================================================
  # Test Suite
  # ============================================================================
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Protocol Buffers compiler
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Setup Rust toolchain
        uses: ./.github/actions/rust-setup
        with:
          toolchain: stable
          cache-key: ci-stable

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Run tests
        run: cargo nextest run --all-features

  # ============================================================================
  # Code Coverage
  # ============================================================================
  coverage:
    name: Code Coverage
    uses: ./.github/workflows/reusable-coverage.yml
    with:
      enforce-100: true  # Stroma requires 100% coverage

  # ============================================================================
  # Dependency Checks
  # ============================================================================
  dependencies:
    name: Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check dependencies
        uses: EmbarkStudios/cargo-deny-action@v2
        with:
          command: check

  # ============================================================================
  # CI Success Gate
  # ============================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [format-and-lint, test, coverage, dependencies]
    if: always()
    steps:
      - name: Check all jobs succeeded
        run: |
          if [[ "${{ needs.format-and-lint.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.coverage.result }}" != "success" ]] || \
             [[ "${{ needs.dependencies.result }}" != "success" ]]; then
            echo "One or more required jobs failed"
            exit 1
          fi
