# Bead: Operator CLI Standards

**Status**: Immutable Architectural Constraint  
**Created**: 2026-02-01  
**Context**: CLI Interface Design

---

## Design Principle

**Operator CLI is for SERVICE MANAGEMENT ONLY** - not trust operations.

**Critical**: Operator cannot execute membership changes, trust operations, or override group decisions. CLI reflects operator least privilege principle.

---

## Command Structure

```bash
stroma <COMMAND> [OPTIONS]

Commands:
  link-device  Link to existing Signal account as secondary device (one-time)
  run          Run bot service (awaits member-initiated bootstrap if new)
  status       Show bot health and embedded kernel status
  verify       Verify configuration and state integrity
  backup-store Export Signal protocol store for backup (encrypted)
  version      Show version information
  help         Show help message
```

**Note**: Bootstrap is **member-initiated** via Signal commands (`/create-group`, `/add-seed`), NOT via operator CLI. See `.beads/bootstrap-seed.bead` for the bootstrap protocol.

---

## Command Specifications

### `link-device` - Link to Signal Account (FIRST STEP)

**Purpose**: Link Stroma as a secondary device to an existing Signal account

**Prerequisite**: Operator must have a Signal account on a primary device (phone). How the operator obtains this account is their responsibility (prepaid SIM, VoIP, etc.).

```bash
stroma link-device \
  --device-name <NAME> \
  --servers <production|staging> \
  --store-path <PATH>
```

**Options:**
- `--device-name`: Name shown in Signal's linked devices list (e.g., "Stroma Bot")
- `--servers`: Signal server environment (default: production)
- `--store-path`: Where to save the Signal protocol store (default: from config)

**What It Does:**
1. Generates provisioning URL via `Manager::link_secondary_device()`
2. Displays QR code in terminal (via qr2term or similar)
3. Waits for operator to scan QR with Signal app on their phone
4. Receives ACI/PNI identity from primary device
5. Saves identity to custom StromaProtocolStore
6. Confirms successful linking

**UX Flow:**
```
$ stroma link-device --device-name "Stroma Bot"

Linking Stroma as secondary device...

Scan this QR code with Signal on your phone:
  Signal â†’ Settings â†’ Linked Devices â†’ Link New Device

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â–ˆâ–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–ˆ   â”‚
â”‚  â–ˆ â–„â–„â–„â–„â–„ â–ˆâ–€â–ˆ â–ˆ   â”‚
â”‚  â–ˆ â–ˆ   â–ˆ â–ˆâ–„â–€ â–ˆ   â”‚
â”‚  ...QR CODE...   â”‚
â”‚  â–ˆâ–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–ˆ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Or use URL: sgnl://linkdevice?uuid=...

Waiting for scan...

âœ… Device linked successfully!
   ACI: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
   Device Name: Stroma Bot
   Store saved to: /var/lib/stroma/signal-store/

âš ï¸  CRITICAL: Backup this Signal store immediately!
    This is your ONLY recovery path for the trust network.

Next step: stroma run --config /etc/stroma/config.toml
```

**Security Notes:**
- Linked devices have FULL messaging and group management capabilities
- The ACI identity becomes the bot's cryptographic identity for ALL operations
- Signal store must be backed up immediately after linking

---

### `run` - Run Bot Service

**Purpose**: Run bot service with embedded Freenet kernel

```bash
stroma run --config <PATH> [--log-level <LEVEL>] [--bootstrap-contact <@USER>]
```

**Options:**
- `--config`: Path to configuration file (required)
- `--log-level`: Logging verbosity (default: info)
- `--bootstrap-contact`: (Optional) Send bootstrap instructions to this user on startup

**What It Does:**
1. Loads configuration
2. Initializes embedded Freenet kernel
3. Authenticates with Signal
4. If no group exists: enters **awaiting bootstrap** state
5. If group exists: loads contract and enters normal operation
6. Starts event loop (monitors Freenet, handles Signal messages)
7. Runs until interrupted

**Bootstrap is Member-Initiated:**

When the bot starts without an existing group, it awaits bootstrap commands from a member:

```
$ stroma run --config config.toml

âœ… Stroma Bot starting...
âœ… Signal connected (ACI: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)
âœ… Embedded Freenet kernel initialized

â³ Awaiting bootstrap...
   No group exists yet. A member must initiate with:
   
   PM to bot: /create-group "Group Name"
   
   The bot will guide them through adding 2 more seed members.

Listening for messages...
```

**Optional: Assisted Bootstrap**

To prompt a specific user to start the bootstrap:

```bash
stroma run --config config.toml --bootstrap-contact @FirstMember
```

This sends a PM to @FirstMember:
```
"ğŸ‘‹ This Stroma bot is ready for setup. 

To create your group, reply with:
  /create-group "Your Group Name"

You'll then add 2 more trusted people as seed members."
```

**Note**: The operator does NOT specify who the seed members are - that remains member-controlled.

---

### `status` - Health Check

**Purpose**: Show bot and embedded kernel health

```bash
stroma status [--config <PATH>]
```

**Shows**: Bot state, kernel state, Signal connection, group info, member count, DVR health metric.

---

### `verify` - Validate Configuration

**Purpose**: Verify config and state integrity without starting bot

```bash
stroma verify --config <PATH>
```

**Checks**: Config file, Signal store, contract key, data directories, phone format.

---

### `backup-store` - Backup Signal Protocol Store

**Purpose**: Export Signal protocol store for secure backup

```bash
stroma backup-store --config <PATH> --output <FILE> --encrypt
```

**Warning**: Signal protocol store IS your cryptographic identity. If lost, ALL trust map data is unrecoverable.

---

## Forbidden Commands (Operator Least Privilege)

### âŒ NEVER Implement These

**Bootstrap Commands (Member-Only via Signal):**
```bash
stroma create-group "Name"      # Member-initiated only (Signal: /create-group)
stroma add-seed @User           # Member-initiated only (Signal: /add-seed)
stroma bootstrap --seed-members # Operator cannot specify seed members
```

**Membership Commands:**
```bash
stroma add-member @User         # Violates automatic-only rule
stroma remove-member @User      # Violates automatic-only rule
stroma override-ejection @User  # Violates trust protocol
```

**Trust Commands:**
```bash
stroma vouch @User              # Only members via Signal bot
stroma flag @User               # Only members via Signal bot
stroma reset-standing @User     # Violates immutability
```

**Configuration Commands:**
```bash
stroma set-config key=value     # Requires group vote
stroma force-config update      # Bypasses consensus
stroma federate-with <GROUP>    # Requires group vote
```

**Why Forbidden**: Operator is service runner, not privileged admin. All trust operations (including bootstrap) go through Signal bot with Freenet verification.

---

## Security Constraints

### Never Accept Trust Operations from CLI

```rust
match cli.command {
    Commands::AddMember { .. } => {
        eprintln!("âŒ Error: Operators cannot manually add members");
        eprintln!("\nMembership changes are automatic based on Freenet contract state.");
        std::process::exit(1);
    }
    _ => { /* ... */ }
}
```

### Never Show Cleartext Signal IDs

```rust
// âœ… GOOD: Show hashes only
println!("- @Alice (hash: 0xabc...)");

// âŒ BAD: Shows cleartext Signal IDs
println!("- Alice (+1234567890)");  // FORBIDDEN
```

---

## Embedded Node Lifecycle (Q1 Validated)

| Use Case | Entry Point |
|----------|-------------|
| Testing | `freenet::dev_tool::SimNetwork` |
| Unit tests | `freenet::local_node::Executor::new_mock_in_memory()` |
| Production | `freenet::local_node::NodeConfig::build()` |

### Graceful Shutdown
```rust
let shutdown = node.shutdown_handle();
shutdown.shutdown();
signal.disconnect().await?;
```
