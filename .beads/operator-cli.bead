# Bead: Operator CLI Standards

**Status**: Immutable Architectural Constraint  
**Created**: 2026-02-01  
**Updated**: 2026-02-12  
**Context**: CLI Interface Design

---

## Design Principle

**Operator CLI is for SERVICE MANAGEMENT ONLY** - not trust operations.

**Critical**: Operator cannot execute membership changes, trust operations, or override group decisions. CLI reflects operator least privilege principle.

---

## Command Structure

```bash
stroma <COMMAND> [OPTIONS]

Commands:
  register     Register new bot as primary device with Signal (phone number)
  link-device  Link to existing Signal account as secondary device (QR code)
  run          Run bot service (awaits member-initiated bootstrap if new)
  status       Show bot health and embedded kernel status
  verify       Verify configuration and state integrity
  backup-store Export Signal protocol store for backup (encrypted)
  unregister   Unregister bot and clean up local data
  version      Show version information
  help         Show help message
```

**Note**: Bootstrap is **member-initiated** via Signal commands (`/create-group`, `/add-seed`), NOT via operator CLI. See `.beads/bootstrap-seed.bead` for the bootstrap protocol.

---

## Default Paths & Auto-Configuration

Stroma uses sensible defaults so operators don't need to write configuration files:

| Item | Default Path | Notes |
|------|--------------|-------|
| Signal store | `~/.local/share/stroma/signal-store/` | Encrypted with passphrase |
| Config file | `~/.local/share/stroma/config.toml` | Auto-generated if missing |
| Passphrase file | `~/.local/share/stroma/passphrase.txt` | Mode 0600, auto-generated |

**Auto-Generation**: When you run `register` or `link-device` without `--passphrase-file`:
1. A 24-word BIP-39 passphrase is generated
2. Saved to `passphrase.txt` (mode 0600) adjacent to the store
3. Default `config.toml` is created with the store path
4. The passphrase is displayed prominently for backup

---

## Command Specifications

### `register` - Register as Primary Device (NEW)

**Purpose**: Register Stroma as a NEW Signal account (primary device)

**Use Case**: When you have a phone number but no existing Signal account to link to.

```bash
stroma register \
  --phone <+E.164> \
  [--store-path <PATH>] \
  [--servers <production|staging>] \
  [--voice] \
  [--captcha <TOKEN>] \
  [--force] \
  [--passphrase-file <PATH>]
```

**Options:**
- `--phone`: Phone number in E.164 format (e.g., `+16137827274`) â€” REQUIRED
- `--store-path`: Where to save Signal protocol store (default: `~/.local/share/stroma/signal-store/`)
- `--servers`: Signal server environment (default: production)
- `--voice`: Use voice call instead of SMS for verification code
- `--captcha`: Captcha token if previous attempt required one
- `--force`: Re-register even if store already exists (deletes existing store)
- `--passphrase-file`: Use existing passphrase from file (for restore from backup)

**What It Does:**
1. Generates 24-word BIP-39 passphrase (or reads from `--passphrase-file`)
2. Creates encrypted Signal protocol store
3. Sends SMS/voice verification to phone number
4. Prompts for verification code
5. Completes registration with Signal servers
6. Saves passphrase to `passphrase.txt` (if generated)
7. Creates default `config.toml`
8. Displays passphrase for backup (CRITICAL)

**UX Flow:**
```
$ stroma register --phone +16137827274

ğŸ” Registering new Stroma bot as primary device...

Sending verification code to +16137827274...
Enter the 6-digit code from SMS: 123456

âœ… Registration successful!
   ACI: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
   Store: ~/.local/share/stroma/signal-store/

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”‘ CRITICAL: Database Passphrase (SAVE THIS SECURELY)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

   1-6   abandon abandon abandon abandon abandon abandon              
   7-12  abandon abandon abandon abandon abandon abandon              
  13-18  abandon abandon abandon abandon abandon abandon              
  19-24  abandon abandon abandon abandon art                          

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Copy-paste version (single line):

  abandon abandon abandon abandon abandon abandon abandon abandon...

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ SAVED TO: ~/.local/share/stroma/passphrase.txt
ğŸ“ Created config: ~/.local/share/stroma/config.toml

Next step: stroma run
```

**When to Use Register vs Link-Device:**

| Scenario | Command |
|----------|---------|
| Fresh phone number, no existing Signal | `register --phone +1...` |
| Have Signal on phone, want bot as linked device | `link-device --device-name "Bot"` |
| VoIP number (SMSPool, Twilio) | `register --phone +1...` |
| Restore from backup | `register --phone +1... --passphrase-file /backup/passphrase.txt` |

---

### `link-device` - Link to Signal Account

**Purpose**: Link Stroma as a secondary device to an existing Signal account

**Prerequisite**: Operator must have a Signal account on a primary device (phone).

```bash
stroma link-device \
  --device-name <NAME> \
  [--store-path <PATH>] \
  [--servers <production|staging>] \
  [--passphrase-file <PATH>]
```

**Options:**
- `--device-name`: Name shown in Signal's linked devices list (e.g., "Stroma Bot") â€” REQUIRED
- `--store-path`: Where to save Signal protocol store (default: `~/.local/share/stroma/signal-store/`)
- `--servers`: Signal server environment (default: production)
- `--passphrase-file`: Use existing passphrase from file (for restore from backup)

**What It Does:**
1. Generates 24-word BIP-39 passphrase (or reads from `--passphrase-file`)
2. Creates encrypted Signal protocol store
3. Displays QR code in terminal
4. Waits for operator to scan QR with Signal app
5. Receives ACI/PNI identity from primary device
6. Saves passphrase to `passphrase.txt` (if generated)
7. Creates default `config.toml`
8. Displays passphrase for backup (CRITICAL)

**UX Flow:**
```
$ stroma link-device --device-name "Stroma Bot"

Linking Stroma as secondary device...

Scan this QR code with Signal on your phone:
  Signal â†’ Settings â†’ Linked Devices â†’ Link New Device

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â–ˆâ–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–ˆ   â”‚
â”‚  â–ˆ â–„â–„â–„â–„â–„ â–ˆâ–€â–ˆ â–ˆ   â”‚
â”‚  ...QR CODE...   â”‚
â”‚  â–ˆâ–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–ˆ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Or use URL: sgnl://linkdevice?uuid=...

Waiting for scan...

âœ… Device linked successfully!

[... passphrase display same as register ...]

Next step: stroma run
```

---

### `run` - Run Bot Service

**Purpose**: Run bot service with embedded Freenet kernel

```bash
stroma run \
  [--config <PATH>] \
  [--store-path <PATH>] \
  [--bootstrap-contact <@USER>] \
  [--passphrase-file <PATH>]
```

**Options:**
- `--config`: Path to config file (default: `~/.local/share/stroma/config.toml`)
- `--store-path`: Path to Signal store (default: `~/.local/share/stroma/signal-store/`)
- `--bootstrap-contact`: (Optional) Send bootstrap instructions to this user on startup
- `--passphrase-file`: Path to passphrase file (default: `~/.local/share/stroma/passphrase.txt`)

**Passphrase Loading Priority:**
1. `--passphrase-file` flag if provided
2. `STROMA_DB_PASSPHRASE` environment variable
3. Default passphrase file (`passphrase.txt` adjacent to store)
4. Interactive prompt (stdin)

**Auto-Configuration:**
- If `config.toml` doesn't exist, a default one is generated
- Config contains ONLY operator settings (paths, logging)
- Trust parameters (min_vouch_threshold, etc.) are in Freenet contract

**What It Does:**
1. Loads configuration (or generates default)
2. Reads passphrase (from file, env, or stdin)
3. Initializes embedded Freenet kernel
4. Authenticates with Signal
5. If no group exists: enters **awaiting bootstrap** state
6. If group exists: loads contract and enters normal operation
7. Starts event loop (monitors Freenet, handles Signal messages)

**UX Flow:**
```
$ stroma run

ğŸš€ Starting Stroma bot service...

Config: ~/.local/share/stroma/config.toml
Store: ~/.local/share/stroma/signal-store/
ğŸ“ Using passphrase from: ~/.local/share/stroma/passphrase.txt

âœ… Signal connected (ACI: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)
âœ… Embedded Freenet kernel initialized

â³ Awaiting bootstrap...
   No group exists yet. A member must initiate with:
   
   PM to bot: /create-group "Group Name"

Listening for messages...
```

**Note**: The operator does NOT specify seed members or trust parameters - those are member-controlled via Signal commands and group consensus.

---

### `status` - Health Check

**Purpose**: Show bot and embedded kernel health

```bash
stroma status
```

**Shows**: Bot state, kernel state, Signal connection, group info, member count, DVR health metric.

---

### `verify` - Validate Configuration

**Purpose**: Verify config and state integrity without starting bot

```bash
stroma verify
```

**Checks**: Config file, Signal store, contract key, data directories, passphrase file.

---

### `backup-store` - Backup Signal Protocol Store

**Purpose**: Export Signal protocol store for secure backup

```bash
stroma backup-store --output <FILE> [--passphrase-file <PATH>]
```

**Options:**
- `--output`: Path to output backup file â€” REQUIRED
- `--passphrase-file`: Path to passphrase file (needed to decrypt store)

**Warning**: Signal protocol store + passphrase IS your cryptographic identity. Both are needed for recovery.

---

### `unregister` - Unregister Bot (NEW)

**Purpose**: Clean up local data and optionally delete Signal account

```bash
stroma unregister \
  [--store-path <PATH>] \
  [--passphrase-file <PATH>] \
  [--delete-account] \
  [--yes]
```

**Options:**
- `--store-path`: Path to Signal store (default: `~/.local/share/stroma/signal-store/`)
- `--passphrase-file`: Path to passphrase file (to decrypt store for server deletion)
- `--delete-account`: Delete account from Signal servers (primary device only)
- `--yes` / `-y`: Skip confirmation prompt

**What It Does:**

**Without `--delete-account` (local cleanup only):**
1. Deletes local Signal store
2. Deletes config file
3. Deletes passphrase file
4. Bot identity remains on Signal servers

**With `--delete-account` (full removal):**
1. Authenticates with Signal servers
2. Deletes account from Signal (unlinks all devices)
3. Deletes all local data

**UX Flow:**
```
$ stroma unregister

âš ï¸  WARNING: This will delete local Stroma data!

The following will be deleted:
  â€¢ Signal store: ~/.local/share/stroma/signal-store/
  â€¢ Config file: ~/.local/share/stroma/config.toml
  â€¢ Passphrase file: ~/.local/share/stroma/passphrase.txt

Note: Signal account will remain active on Signal servers.
      Use --delete-account to also delete from Signal.

Continue? [y/N]: y

ğŸ—‘ï¸  Deleting local data...
âœ… Unregistration complete.
```

**With `--delete-account`:**
```
$ stroma unregister --delete-account

âš ï¸  WARNING: This will PERMANENTLY delete the Signal account!

This is IRREVERSIBLE. The phone number can be re-registered, but:
  â€¢ All linked devices will be disconnected
  â€¢ Message history will be lost
  â€¢ Group memberships will be lost

Continue? [y/N]: y

ğŸ—‘ï¸  Deleting Signal account from servers...
ğŸ—‘ï¸  Deleting local data...
âœ… Account deleted and local data removed.
```

**When to Use:**
- Decommissioning a bot permanently
- Starting fresh with a new identity
- Troubleshooting registration issues

---

## Configuration Model

### StromaConfig (Operator Settings ONLY)

The `config.toml` file contains ONLY operator-level settings:

```toml
# Stroma Bot Configuration (Operator Settings)
#
# NOTE: Trust model parameters (min_vouch_threshold, max_flags, etc.)
# are NOT configured here. They are controlled by GROUP CONSENSUS
# via Signal Polls and stored in the Freenet contract.
#
# See: .beads/security-constraints.bead (Operator Least Privilege)

[signal]
store_path = "/home/stroma/.local/share/stroma/signal-store"
device_name = "Stroma Bot"

[freenet]
listen_port = 0
is_gateway = false
gateways = ["gateway1.freenetproject.org:12345"]
state_dir = "/home/stroma/.local/share/stroma/freenet-state"

[logging]
level = "info"
file = "/var/log/stroma/bot.log"
```

**What's NOT in StromaConfig** (because it's group-controlled):
- `min_vouch_threshold` â€” Group consensus
- `max_flags` â€” Group consensus
- `standing_ranges` â€” Group consensus
- Any trust model parameters

**Why**: Operator Least Privilege principle. Operators are service runners, not privileged admins who can control trust parameters.

---

## Forbidden Commands (Operator Least Privilege)

### âŒ NEVER Implement These

**Bootstrap Commands (Member-Only via Signal):**
```bash
stroma create-group "Name"      # Member-initiated only (Signal: /create-group)
stroma add-seed @User           # Member-initiated only (Signal: /add-seed)
stroma bootstrap --seed-members # Operator cannot specify seed members
```

**Membership Commands:**
```bash
stroma add-member @User         # Violates automatic-only rule
stroma remove-member @User      # Violates automatic-only rule
stroma override-ejection @User  # Violates trust protocol
```

**Trust Commands:**
```bash
stroma vouch @User              # Only members via Signal bot
stroma flag @User               # Only members via Signal bot
stroma reset-standing @User     # Violates immutability
```

**Configuration Commands:**
```bash
stroma set-min-vouches 3        # Requires group vote via Signal Poll
stroma set-config key=value     # Requires group vote
stroma force-config update      # Bypasses consensus
stroma federate-with <GROUP>    # Requires group vote
```

**Why Forbidden**: Operator is service runner, not privileged admin. All trust operations (including bootstrap) go through Signal bot with Freenet verification. Trust parameters are group-controlled via Signal Polls.

---

## Security Constraints

### Never Accept Trust Operations from CLI

```rust
match cli.command {
    Commands::AddMember { .. } => {
        eprintln!("âŒ Error: Operators cannot manually add members");
        eprintln!("\nMembership changes are automatic based on Freenet contract state.");
        std::process::exit(1);
    }
    _ => { /* ... */ }
}
```

### Never Show Cleartext Signal IDs

```rust
// âœ… GOOD: Show hashes only
println!("- @Alice (hash: 0xabc...)");

// âŒ BAD: Shows cleartext Signal IDs
println!("- Alice (+1234567890)");  // FORBIDDEN
```

---

## Embedded Node Lifecycle (Q1 Validated)

| Use Case | Entry Point |
|----------|-------------|
| Testing | `freenet::dev_tool::SimNetwork` |
| Unit tests | `freenet::local_node::Executor::new_mock_in_memory()` |
| Production | `freenet::local_node::NodeConfig::build()` |

### Graceful Shutdown
```rust
let shutdown = node.shutdown_handle();
shutdown.shutdown();
signal.disconnect().await?;
```
