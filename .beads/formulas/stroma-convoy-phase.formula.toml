description = """
Stroma Phase Convoy - orchestrates a complete implementation phase.

This formula guides the Mayor through managing a convoy of parallel polecats
working on a Stroma implementation phase.

Each phase has:
1. Multiple parallel tracks (Agent-Crypto, Agent-Freenet, Agent-Signal)
2. Continuous Witness oversight (security patrol)
3. Quality gates before closure
4. Documentation requirements

## Convoy Structure

```
                    ┌─────────────────┐
                    │     Mayor       │
                    │  (Orchestrator) │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
     ┌────────▼────┐  ┌──────▼──────┐  ┌───▼───────┐
     │ Agent-Crypto│  │Agent-Freenet│  │Agent-Signal│
     │   (HMAC,    │  │  (kernel,   │  │   (bot,   │
     │   STARKs)   │  │  contract)  │  │   polls)  │
     └─────────────┘  └─────────────┘  └───────────┘
              │              │              │
              └──────────────┼──────────────┘
                             │
                    ┌────────▼────────┐
                    │    Witness      │
                    │ (Security Audit)│
                    └─────────────────┘
```

## Variables

| Variable | Description |
|----------|-------------|
| phase | Phase identifier (e.g., "phase0", "phase1") |
| convoy_id | Convoy ID (e.g., "convoy-phase0") |
"""
formula = "stroma-convoy-phase"
version = 1

[[steps]]
id = "review-phase-scope"
title = "Review phase scope and beads"
description = """
**Before spawning polecats, understand the phase.**

**1. Read the TODO for this phase:**
```bash
# Find the phase section
rg "## .* PHASE" docs/todo/TODO.md -A 50 | head -100
```

**2. List beads for this phase:**
```bash
bd list --convoy {{convoy_id}}
```

**3. Identify dependencies:**
- Which beads can run in parallel?
- Which beads depend on others?
- Which agents should work on which beads?

**4. Read constraint beads:**
```bash
cat .beads/security-constraints.bead | head -50
cat .beads/testing-standards.bead | head -50
```

**Exit criteria:** Phase scope understood, dependencies mapped.
"""

[[steps]]
id = "spawn-witness"
title = "Spawn Witness agent FIRST"
needs = ["review-phase-scope"]
description = """
**CRITICAL: Witness MUST be active before any implementation work.**

The Witness runs the `stroma-security-witness` formula, continuously
scanning for violations of the 8 Absolutes.

**1. Spawn Witness:**
```bash
gt spawn --role witness --formula stroma-security-witness
```

**2. Verify Witness is running:**
```bash
gt session status witness
```

**3. Check Witness inbox is clear:**
```bash
gt mail inbox witness/
```

**Why Witness first?**
- Polecats cannot submit work if Witness has flagged violations
- Continuous oversight catches problems early
- Security is not an afterthought

**Exit criteria:** Witness actively patrolling.
"""

[[steps]]
id = "create-beads"
title = "Create beads for work units"
needs = ["spawn-witness"]
description = """
**Create beads for each deliverable in the phase.**

**1. Create beads with proper metadata:**
```bash
# Example for Phase 0
bd create --title "HMAC identity masking with zeroization" \
  --convoy {{convoy_id}} \
  --labels agent-crypto,trust-critical

bd create --title "Embedded Freenet kernel integration" \
  --convoy {{convoy_id}} \
  --labels agent-freenet

bd create --title "Signal bot with custom protocol store" \
  --convoy {{convoy_id}} \
  --labels agent-signal

bd create --title "STARK circuits for vouch verification" \
  --convoy {{convoy_id}} \
  --labels agent-crypto,trust-critical

bd create --title "Freenet contract schema (TrustNetworkState)" \
  --convoy {{convoy_id}} \
  --labels agent-freenet,trust-critical
```

**2. Add dependency links if needed:**
```bash
bd update <bead-id> --depends-on <other-bead-id>
```

**3. Verify beads created:**
```bash
bd list --convoy {{convoy_id}}
```

**Exit criteria:** All phase deliverables have beads.
"""

[[steps]]
id = "spawn-polecats"
title = "Spawn specialized polecats"
needs = ["create-beads"]
description = """
**Spawn polecats for parallel tracks.**

**1. Spawn Agent-Crypto (if crypto beads exist):**
```bash
gt spawn --role agent-crypto \
  --bead <hmac-bead-id> \
  --formula stroma-polecat-rust
```

**2. Spawn Agent-Freenet (if Freenet beads exist):**
```bash
gt spawn --role agent-freenet \
  --bead <kernel-bead-id> \
  --formula stroma-polecat-rust
```

**3. Spawn Agent-Signal (if Signal beads exist):**
```bash
gt spawn --role agent-signal \
  --bead <signal-bead-id> \
  --formula stroma-polecat-rust
```

**4. Notify Witness of new polecats:**
```bash
gt mail send witness/ -s "SWARM_START" -m "Convoy: {{convoy_id}}
Polecats: <list>
Beads: <list>"
```

**Parallelism:**
- Independent beads can be worked on simultaneously
- Dependent beads must wait for dependencies
- Witness monitors ALL polecats continuously

**Exit criteria:** Polecats spawned and working.
"""

[[steps]]
id = "monitor-progress"
title = "Monitor polecat progress"
needs = ["spawn-polecats"]
description = """
**Periodically check convoy status.**

**1. Check polecat status:**
```bash
bd list --convoy {{convoy_id}} --status in_progress
bd list --convoy {{convoy_id}} --status completed
bd list --convoy {{convoy_id}} --status blocked
```

**2. Check for security violations:**
```bash
bd list --labels security --status open
```

If any security beads exist, convoy is BLOCKED until resolved.

**3. Check Witness status:**
```bash
gt session status witness
gt mail inbox  # Look for escalations
```

**4. Handle blocked polecats:**
```bash
# Read help requests
gt mail inbox

# Provide guidance or reassign work
gt mail send <polecat>/ -s "GUIDANCE" -m "<instructions>"
```

**5. Handle completed polecats:**
Polecats self-clean via `gt done`. No action needed from Mayor
unless merge conflicts arise (Refinery handles).

**Exit criteria:** All beads in convoy completed or blocked with known issues.
"""

[[steps]]
id = "quality-gates"
title = "Verify quality gates before closure"
needs = ["monitor-progress"]
description = """
**ALL gates MUST pass before convoy closure.**

**1. Format check:**
```bash
cargo fmt --check
```

**2. Lint check:**
```bash
cargo clippy --all-targets --all-features -- -D warnings
```

**3. Supply chain audit:**
```bash
cargo deny check
```

**4. Coverage check (100% REQUIRED):**
```bash
cargo llvm-cov nextest --all-features --fail-under-lines 100
```

If < 100%, identify gaps and create beads for additional tests.

**5. Build check:**
```bash
cargo build --release --target x86_64-unknown-linux-musl
```

**6. Security verification:**
```bash
# No cleartext Signal IDs
rg '\\+1?\\d{10,15}' --type rust src/

# No SqliteStore
rg 'SqliteStore|presage-store-sqlite' --type rust src/ Cargo.toml

# No polling patterns
rg 'loop.*sleep|while.*sleep' --type rust src/

# All should return empty
```

**7. Witness sign-off:**
```bash
bd list --labels security --status open
```
MUST be empty. If any security beads open, convoy BLOCKED.

**Exit criteria:** All quality gates pass.
"""

[[steps]]
id = "update-documentation"
title = "Update affected documentation"
needs = ["quality-gates"]
description = """
**Documentation drift is a defect.**

**1. Identify affected docs:**

| If you changed... | Update these docs |
|-------------------|-------------------|
| User-facing commands | `docs/USER-GUIDE.md` |
| Trust logic/thresholds | `docs/TRUST-MODEL.md`, `docs/HOW-IT-WORKS.md` |
| Operator setup/CLI | `docs/OPERATOR-GUIDE.md` |
| Module structure | `docs/DEVELOPER-GUIDE.md` |
| Security constraints | `docs/THREAT-MODEL.md`, `docs/SECURITY-CI-CD.md` |
| Algorithms (DVR, etc) | `docs/ALGORITHMS.md` |
| Persistence model | `docs/PERSISTENCE.md` |
| Federation | `docs/FEDERATION.md` |

**2. Update relevant docs:**
Ensure all behavior changes are reflected in documentation.

**3. Verify no placeholders:**
```bash
rg "TODO|FIXME|PLACEHOLDER" docs/
```
MUST return empty.

**4. Commit doc updates:**
```bash
git add docs/
git commit -m "$(cat <<'EOF'
docs: update documentation for {{phase}}

Co-authored-by: Claude <noreply@anthropic.com>
EOF
)"
```

**Exit criteria:** Documentation current, no placeholders.
"""

[[steps]]
id = "convoy-close"
title = "Close convoy"
needs = ["update-documentation"]
description = """
**Finalize and close the convoy.**

**1. Sync beads:**
```bash
bd sync
```

**2. Close convoy:**
```bash
gt convoy close {{convoy_id}} --summary "{{phase}} complete"
```

**3. Push to remote:**
```bash
git push
```

**4. Update TODO:**
Update `docs/todo/TODO.md` to mark phase complete.

**5. Create next convoy (if applicable):**
```bash
gt convoy create --title "Phase N+1: <name>" \
  --depends-on {{convoy_id}}
```

**Exit criteria:** Convoy closed, changes pushed, next phase ready.
"""

[vars]
[vars.phase]
description = "Phase identifier (e.g., phase0, phase1)"
required = true

[vars.convoy_id]
description = "Convoy ID (e.g., convoy-phase0)"
required = true
