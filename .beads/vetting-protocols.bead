# Bead: Vetting Protocols

**Status**: Immutable Architectural Constraint  
**Created**: 2026-02-01  
**Context**: Admission, Vetting, and Ejection Protocols

---

## Related Beads

This bead provides an overview. For detailed specifications, see:

| Topic | Bead | Purpose |
|-------|------|---------|
| **Terminology** | `.beads/terminology.bead` | Canonical definitions (Member, Bridge, Validator, etc.) |
| **Bootstrap** | `.beads/bootstrap-seed.bead` | One-time seed group creation process |
| **Cross-Cluster** | `.beads/cross-cluster-requirement.bead` | Formal definition and enforcement |
| **Mesh Health** | `.beads/mesh-health-metric.bead` | DVR calculation and health tiers |
| **Blind Matchmaker** | `.beads/blind-matchmaker-dvr.bead` | Strategic introduction algorithm |
| **Trust Calculations** | `.beads/security-constraints.bead` | Standing formula, ejection triggers |
| **User Experience** | `.beads/user-roles-ux.bead` | Bot commands, member journey |
| **Freenet State** | `.beads/freenet-contract-design.bead` | State structure, CRDT merge semantics |
| **Decisions** | `.beads/architectural-decisions-open.bead` | Flag persistence, ejected state, vouch revocation |
| **Philosophy** | `.beads/philosophical-foundations.bead` | Accountability vs. forgiveness duality |

---

## Core Invariant

**Signal Group = Fully Vetted Members Only**

Every member in the Signal group has met the admission requirements. Invitees (being vetted) are OUTSIDE the group until fully admitted.

---

## Member Lifecycle

**Canonical Source**: `.beads/terminology.bead` (Member Roles section)

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Outside   â”‚  Not in Stroma
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ /invite (first vouch)
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Invitee   â”‚  1 vouch, OUTSIDE group
                    â”‚ (Leaf Node) â”‚  Being vetted
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ Second vouch (cross-cluster)
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Bridge    â”‚  2 vouches, IN group
                    â”‚  (Member)   â”‚  Minimum requirement
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ Additional vouches
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Validator  â”‚  3+ vouches, IN group
                    â”‚  (Member)   â”‚  Used for optimization
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Standing < 0            â”‚ Effective_Vouches < 2
              â”‚ OR                      â”‚
              â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Ejected   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Ejected   â”‚
        â”‚(flags stay) â”‚          â”‚(flags stay) â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
               â”‚                        â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ Re-entry: 2+ new vouches
                        â”‚ (flags persist, higher bar)
                        â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚   Bridge    â”‚  Back in group
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Cross-Cluster Requirement

**Canonical Source**: `.beads/cross-cluster-requirement.bead`

| Role | Vouch Count | Cluster Requirement |
|------|-------------|---------------------|
| Bridge | 2 vouches | 2 different clusters |
| Validator | 3+ vouches | min(vouch_count, available_clusters) |

**Single-Cluster Exception**: When only 1 cluster exists (bootstrap or organic convergence), cross-cluster requirement is not enforced. Enforcement begins when `clusters >= 2`.

**Why Cross-Cluster**: Prevents coordinated infiltration. Same-cluster vouching allows bad actors to rubber-stamp each other.

---

## Bootstrap: Seed Group

**Canonical Source**: `.beads/bootstrap-seed.bead`

**One-time process** to create the initial 3-member seed group:

1. **Size**: 3 members (minimum for triangulation)
2. **Process**: Member-initiated via Signal commands (`/create-group`, `/add-seed`)
3. **Result**: Initial triangle with mutual vouches (each member has 2 vouches)
4. **Transition**: Bot becomes sole admin, all future admissions via protocol

**Key Constraint**: Operator does NOT manually add members. Bootstrap is member-initiated.

---

## Admission Protocol

### Phase 1: Invitation (First Vouch)

**Command**: `/invite @PotentialMember "Optional context"`

- Invitation counts as first vouch
- ANY Member can invite (Bridges and Validators)
- Invitee becomes a leaf node in the trust graph, OUTSIDE the group
- Bot creates ephemeral VettingSession (RAM only, never persisted)

**See**: `.beads/user-roles-ux.bead` for command details

### Phase 2: Assessor Selection (Blind Matchmaker)

**Canonical Source**: `.beads/blind-matchmaker-dvr.bead`

- Bot selects an **assessor** from a DIFFERENT cluster than inviter
- Assessor can be a bridge (2 vouches) or validator (3+ vouches) -- both are eligible
- Prioritizes DVR optimization (create distinct Validators with non-overlapping voucher sets)
- Falls back to MST algorithm if no DVR-optimal match
- Bootstrap exception: any member when only 1 cluster exists

### Phase 3: Assessment (PM-Only, No Secondary Chats)

**Critical constraint**: The bot belongs to exactly one Signal group. It NEVER creates 3-person chats, secondary groups, or any other Signal group. All bot communication is 1-on-1 PMs.

- Bot sends PM to assessor with: invitee's Signal contact info, inviter-provided context, previous-flags warning if applicable
- Bot does NOT reveal the inviter's identity to the assessor (Blind Matchmaker)
- Bot does NOT reveal the assessor's identity to the inviter
- Bot does NOT contact the invitee directly
- **Assessor independently contacts the invitee** -- they decide how to approach, what to share about themselves, and whether to reveal their membership
- Assessor evaluates the invitee through direct conversation

**Assessor actions:**
- `/vouch @invitee` -- Confirm the invitee (counts as cross-cluster vouch)
- `/reject-intro @invitee` -- Decline the assessment (bot selects a new assessor, excluding those who declined)

### Phase 4: Admission

Admission is gated on **ALL GroupConfig requirements**, not a hardcoded threshold:

1. **Verify**: `effective_vouches >= config.min_vouch_threshold` (default 2, configurable via `/propose`)
2. **Verify**: Cross-cluster requirement met (or Single-Cluster Exception)
3. **Verify**: Standing is non-negative
4. **Prove**: Generate and verify STARK proof of vouch verification
5. **Record**: Push vouch records to Freenet contract
6. **Wait**: Freenet confirms state update
7. **Add**: Bot adds member to Signal group
8. **Announce**: Group notification (using member hash, not names)
9. **Delete**: Ephemeral vetting session data removed immediately
10. **Notify**: Inviter is notified that their invitee has been admitted

If vouch is recorded but admission threshold is NOT yet met, the session stays active. The assessor is notified that the invitee still needs additional vouches.

**See**: `.beads/freenet-contract-design.bead` for state structure

---

## Ejection Protocol

**Canonical Source**: `.beads/security-constraints.bead` (Section 2)

### Two Independent Triggers

| Trigger | Condition | Meaning |
|---------|-----------|---------|
| **Standing < 0** | `Effective_Vouches - Regular_Flags < 0` | Too many regular flags |
| **Effective_Vouches < 2** | Voucher left OR voucher flagged you | Below minimum threshold |

### Standing Calculation

**Canonical Source**: `.beads/terminology.bead` (Trust Calculations)

```
Voucher-Flaggers = All_Vouchers âˆ© All_Flaggers
Effective_Vouches = |All_Vouchers| - |Voucher_Flaggers|
Regular_Flags = |All_Flaggers| - |Voucher_Flaggers|
Standing = Effective_Vouches - Regular_Flags
```

**Key Insight**: Voucher-flaggers are excluded from BOTH counts (prevents 2-point swings).

### No Grace Periods

**Canonical Source**: `.beads/security-constraints.bead` (Section 2)

- âŒ NO warnings before ejection
- âŒ NO re-verification windows
- âŒ NO delayed ejection
- âœ… Immediate ejection when threshold violated

**Rationale**: Grace periods create exploitable windows. See `.beads/philosophical-foundations.bead` for accountability vs. forgiveness duality.

---

## Edge Cases & Exceptions

### Cluster Depletion During Vetting

If a cluster is destroyed (members ejected) while an invitee is being vetted:
- Invitee's existing vouch(es) remain valid
- Bot must find a new member from a different remaining cluster
- If no other clusters exist, Single-Cluster Exception applies

### Re-Admission After Ejection

**Canonical Source**: `.beads/architectural-decisions-open.bead` (Decisions #1, #10)

Ejected members can be re-admitted through the normal admission process:

| Aspect | Behavior |
|--------|----------|
| **Flags** | Previous flags persist (carried over from before ejection) |
| **Vouches** | Must secure 2+ new cross-cluster vouches from current members |
| **Standing** | New vouches - Previous flags |
| **Difficulty** | Higher bar if flagged (3 flags = need 4+ vouches for positive standing) |
| **Cooldown** | None - re-entry can happen immediately if vouches secured |

**Example**: Alice ejected with 3 flags needs 4+ vouches to re-enter with positive standing.

**Rationale**: Accountability over forgiveness for flag history. Community memory of concerns is preserved. See `.beads/philosophical-foundations.bead`.

---

## Two Distinct Blind Matchmaker Roles

**Canonical Source**: `.beads/terminology.bead` (Bot Roles section), `.beads/blind-matchmaker-dvr.bead`

The Blind Matchmaker has two architecturally separate functions. They share the DVR-optimized selection algorithm but serve different purposes:

### Admission Vetting (Assessor Selection)

**Module**: `signal/matchmaker.rs`  
**Trigger**: `/invite` command  
**Purpose**: Select a cross-cluster assessor to evaluate an invitee for admission.

- Invitee is a leaf node (1 vouch, outside group)
- Bot selects assessor via DVR-optimized algorithm with exclusion list
- Bot PMs assessor with invitee contact info
- Assessor independently contacts invitee
- Assessor vouches (`/vouch`) or declines (`/reject-intro`)

### Mesh Optimization (Strategic Introductions)

**Module**: `matchmaker/strategic_intro.rs`  
**Trigger**: `/mesh` health suggestions, proactive bot behavior based on DVR health status  
**Purpose**: Suggest cross-cluster introductions between existing members to improve network resilience.

| Phase | Action | Goal |
|-------|--------|------|
| **Phase 0 (DVR)** | Suggest introductions that create Distinct Validators | Maximize independently-verified members |
| **Phase 1 (MST)** | If no DVR-optimal match, accept any cross-cluster vouch | Strengthen bridges |
| **Phase 2 (Islands)** | Bridge disconnected clusters | Ensure full connectivity |

**Health Metric**: Distinct Validator Ratio (DVR) = Distinct_Validators / (N / 4)

**See**: `.beads/mesh-health-metric.bead` for DVR calculation and three-tier health status (ğŸ”´ Unhealthy, ğŸŸ¡ Developing, ğŸŸ¢ Healthy).

---

## Continuous Health Monitoring

**Canonical Source**: `.beads/freenet-integration.bead` (State Stream)

### Real-Time State Stream (NOT Polling)

```rust
async fn membership_health_monitor(
    signal: &impl SignalClient,
    freenet: &impl FreenetClient,
) {
    let mut stream = freenet.subscribe_to_state_changes().await;
    
    while let Some(change) = stream.next().await {
        match change {
            StateChange::VouchRemoved { member, .. } |
            StateChange::FlagAdded { member, .. } => {
                let state = freenet.get_member_state(member).await;
                if state.effective_vouches < MIN_VOUCH_THRESHOLD {
                    signal.remove_member(member).await;
                }
                if state.standing < 0 {
                    signal.remove_member(member).await;
                }
            },
            _ => {}
        }
    }
}
```

**Key Points**:
- âœ… Use real-time Freenet state stream (react to `StateChange` events)
- âŒ DO NOT use polling with sleep loops
- âœ… Immediate ejection when either trigger activated

**See**: `.beads/testing-standards.bead` for integration testing patterns with mock Signal/Freenet.

---

## Key Architectural Principles

| Principle | Description | Reference |
|-----------|-------------|-----------|
| **Waiting Room = Outside Group** | Invitees are not in a separate chat; they're simply outside Signal group | `terminology.bead` |
| **Invitees = OUTSIDE Group** | 1 vouch, being vetted, cannot participate | `terminology.bead` |
| **Bridges = IN Group** | 2 vouches, minimum requirement for membership | `terminology.bead` |
| **Validators = IN Group** | 3+ vouches, used for Blind Matchmaker optimization only | `terminology.bead` |
| **Gatekeeper** | Bot strictly enforces 2-vouch requirement | `signal-integration.bead` |
| **Immediate Ejection** | No grace periods, no warnings | `security-constraints.bead` |
| **Vouch Permissions** | ANY Member can vouch (not restricted to Validators) | `security-constraints.bead` |
| **Flags Persist** | Ejected members keep their flag history on re-entry | `architectural-decisions-open.bead` |
| **No Permanent Bans** | Ejected members can always re-enter with sufficient vouches | `philosophical-foundations.bead` |

---

## Gastown Agent Instructions

**When implementing admission vetting:**
1. Read `.beads/terminology.bead` for canonical definitions (especially Assessor)
2. Read `.beads/cross-cluster-requirement.bead` for enforcement logic
3. Read `.beads/security-constraints.bead` for ejection triggers
4. Admission vetting code lives in `signal/matchmaker.rs` -- NOT in `matchmaker/strategic_intro.rs`
5. Use trait abstractions for Signal/Freenet (see `.beads/testing-standards.bead`)

**When implementing mesh optimization:**
1. Read `.beads/blind-matchmaker-dvr.bead` for algorithm details
2. Read `.beads/mesh-health-metric.bead` for DVR calculation
3. Mesh optimization code lives in `matchmaker/strategic_intro.rs` -- NOT in `signal/matchmaker.rs`

**When implementing health monitoring:**
1. Use real-time Freenet state stream (NOT polling)
2. Check BOTH ejection triggers on every state change
3. Immediate action when threshold violated

**Anti-Patterns to Avoid:**
- âŒ Restricting vouching to Validators only
- âŒ Adding grace periods or warnings before ejection
- âŒ Polling instead of state stream
- âŒ Storing Signal IDs in cleartext during vetting
- âŒ Persisting vetting session data after admission
- âŒ Creating 3-person chats or secondary Signal groups (bot belongs to ONE group only)
- âŒ Bot contacting invitees directly (assessor contacts them independently)
- âŒ Revealing inviter identity to assessor or assessor identity to inviter
- âŒ Hardcoding admission threshold (use GroupConfig.min_vouch_threshold)
- âŒ Mixing admission vetting code with mesh optimization code
