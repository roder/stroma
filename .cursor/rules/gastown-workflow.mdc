---
description: Gastown-specific workflow patterns and agent coordination
alwaysApply: true
---

# Gastown Workflow Standards

## Agent Organization

### Agent Roles
- **Mayor (Lead Agent)**: Project architecture and security auditing
- **Agent-Signal**: `libsignal-service-rs` and protocol-level group management
- **Agent-Freenet**: Wasm contract development with ComposableState, summary-delta synchronization
- **Agent-Crypto**: STARK circuits (winterfell) and HMAC identity masking
- **Witness Agent**: Constant audit of other agents to ensure no Signal ID logging

### Context Persistence
- Use **Beads** (git-backed persistent memory) for all architectural constraints
- Store security constraints (Anonymity-First, No Time Windows) in `.beads/` directory
- Ensure sub-agents read constraints before writing code

## Implementation Roadmap (Beads)

### Spike Week (Week 0 - Validation)
**CRITICAL**: Validate freenet-core ComposableState, Signal bot, STARK proofs before full implementation

**Outstanding Questions** (Spike Week Status — ALL COMPLETE):
1. ✅ **Q1 ANSWERED (GO)**: Freenet merge conflicts — use commutative deltas with set-based state + tombstones
2. ✅ **Q2 ANSWERED (GO)**: Contract validation — `update_state()` and `validate_state()` can reject invalid deltas/state (trustless model viable)
3. ✅ **Q3 ANSWERED (GO)**: Cluster detection — Bridge Removal algorithm distinguishes tight clusters
4. ✅ **Q4 ANSWERED (PARTIAL)**: STARK verification — bot-side verification for Phase 0 (Wasm experimental)
5. ✅ **Q5 ANSWERED (GO)**: Merkle Tree performance — 0.09ms for 1000 members (on-demand OK)
6. ✅ **Q6 ANSWERED**: Proof storage — store outcomes only (not proofs)

### Phase 0: Foundation (Weeks 1-2)
1. **Bead-01**: HMAC identity masking with zeroization
2. **Bead-02**: freenet-core node and state stream monitoring
3. **Bead-03**: Signal bot authentication and commands
4. **Bead-04**: STARK circuits for vouch verification
5. **Bead-05**: Freenet contract schema with ComposableState (set-based, mergeable)

### Phase 1: Bootstrap & Core Trust (Weeks 3-4)
6. **Bead-06**: Bootstrap seed group (3 members, triangle vouching)
7. **Bead-07**: Invitation & vetting flow (no token exchange)
8. **Bead-08**: Admission protocol (ZK-proof verification)
9. **Bead-09**: Ejection protocol (two independent triggers)
10. **Bead-10**: Health monitoring (continuous standing checks)

### Phase 2: Mesh Optimization (Weeks 5-6)
11. **Bead-11**: Graph topology analysis (Blind Matchmaker)
12. **Bead-12**: Internal cluster detection
13. **Bead-13**: Strategic introduction suggestions (MST)
14. **Bead-14**: Configuration management (Signal Polls)
15. **Bead-15**: Advanced commands (/mesh, /mesh strength, /propose)

### Phase 3: Federation Prep (Week 7)
16. **Bead-16**: Social Anchor hashing (compute locally, don't broadcast)
17. **Bead-17**: PSI-CA implementation (test with mock data)
18. **Bead-18**: Federation hooks validation
19. **Bead-19**: Documentation for Phase 4

## Safety Precautions

### Refinery Audits
- **Mandatory**: Manually review Refinery output for any `unsafe` Rust blocks
- Refinery manages merges - verify security constraints are maintained

### Hook State Checks
- Regularly check git worktrees (Hooks) for accidental commits
- Ensure no "Private Salt" or test-keys in git history
- Verify no Signal IDs committed

### Deacon Monitoring
- Use Gastown Deacon to monitor bot build health
- Significant build size increases indicate dependency bloat
- Violates minimal attack surface requirement

## Parallel Execution (Convoy)

### Agent Coordination
- Use `gt convoy` for parallel development
- Ensure Witness Agent audits all other agents simultaneously
- Never allow agents to work in isolation without oversight

## Context Preservation

### Bead Requirements
- Pin architectural constraints as **Immutable Beads**
- Store in `.beads/` directory for persistent access
- All agents must read relevant Beads before task execution

### System Prompt Integration
- Mayor must receive system prompt with security constraints
- Store constraints in Beads for sub-agent access
- Ensure context survives across agent sessions

## Quality Gates

### Before Agent Completion
- Security constraints verified
- No unsafe blocks introduced
- No cleartext identifiers stored
- Freenet state verification maintained
- Supply chain audits passed
