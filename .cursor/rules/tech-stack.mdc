---
description: Tech stack requirements, dependencies, and integration patterns for Stroma
alwaysApply: true
---

# Tech Stack Standards & Guardrails

## Target Architecture

**Core Stack:** Rust Static Binary | Signal Protocol | Freenet (Dark) | ZK-Proofs

### Architecture Principles
- **Static Binary**: Must produce statically linked MUSL binary
- **Minimal Attack Surface**: Keep dependencies minimal, monitor binary size
- **Privacy-First**: All integrations must preserve anonymity
- **Decentralized**: No centralized trust authority or coordination

## Required Dependencies

### Core Cryptographic Libraries

#### `ring`
- **Purpose**: HMAC generation and cryptographic operations
- **Usage**: Identity masking with keyed hashing (not deterministic hashing)
- **Version**: Use latest stable, audited version
- **Pattern**:
  ```rust
  use ring::{digest, hmac};
  
  // For HMAC-based identity masking with group-secret pepper
  let key = hmac::Key::new(hmac::HMAC_SHA256, group_secret_pepper);
  let tag = hmac::sign(&key, signal_id.as_bytes());
  ```

#### `zeroize`
- **Purpose**: Memory hygiene - purge sensitive buffers
- **Usage**: **Mandatory** for all identity masking operations
- **Requirement**: Must zeroize immediately after hashing
- **Pattern**:
  ```rust
  use zeroize::Zeroize;
  
  // Zeroize sensitive data immediately after use
  buffer.zeroize();
  ```

#### `arkworks`
- **Purpose**: ZK-SNARK circuit implementation
- **Usage**: Trust verification, recursive ZK vouching
- **Requirement**: Must implement recursive proofs for scalability
- **Integration**: Freenet contracts accept ZK-SNARK as input

### Protocol Integration Libraries

#### Signal Protocol Stack

**Architecture Layers:**
```
Signal Protocol (specification)
        ↓
libsignal-service-rs (low-level Rust implementation)
        ↓
Presage (high-level Rust convenience API)
        ↓
Stroma Bot
```

#### `Presage` (Primary)
- **Repository**: https://github.com/whisperfish/presage
- **Purpose**: High-level Signal client library (wraps libsignal-service-rs)
- **License**: AGPL-3.0
- **Usage**: 
  - Bot commands and message handling
  - Group management (create, add/remove members, settings)
  - 1-on-1 PMs for vetting
  - Registration and authentication
- **Features**:
  - `Manager` API for high-level operations
  - **Custom Store Required** (NOT SqliteStore - server seizure risk)
  - Connection lifecycle management
- **Pattern**:
  ```rust
  use presage::Manager;
  // ❌ DO NOT USE: use presage_store_sqlite::SqliteStore;
  // SqliteStore stores ALL messages - violates server seizure protection!
  
  use stroma::store::StromaProtocolStore;  // ✅ Custom minimal store
  
  let store = StromaProtocolStore::new()?;
  let manager = Manager::with_store(store, options).await?;
  manager.send_message_to_group(master_key, message, timestamp).await?;
  ```

#### `libsignal-service-rs` (When Needed)
- **Repository**: https://github.com/whisperfish/libsignal-service-rs
- **Purpose**: Low-level Signal protocol primitives
- **When to Use**: When Presage doesn't expose needed features
- **Usage**:
  - Custom protobuf message types
  - Raw cipher operations
  - Features not wrapped by Presage
- **Pattern**:
  ```rust
  use presage::libsignal_service::proto::DataMessage;
  use presage::libsignal_service::proto::data_message::Poll;
  
  // ❌ DO NOT USE Reaction for voting (exposes voter identity)
  // ✅ Use Signal Polls for anonymous voting
  // Access low-level types through Presage's re-exports
  ```

#### Poll Support (Protocol v8)
- **Status**: libsignal-service-rs currently on protocol v7 (polls missing)
- **Solution**: Fork libsignal-service-rs, add protocol v8 poll support
- **Strategy**: Use our fork until upstream merges
- **Implementation**: Gastown Agent-Signal task (see `.beads/poll-implementation-gastown.bead`)
- **Cargo.toml**:
  ```toml
  [dependencies]
  presage = { git = "https://github.com/whisperfish/presage" }
  
  [patch.crates-io]
  libsignal-service = { 
      git = "https://github.com/roder/libsignal-service-rs",
      branch = "feature/protocol-v8-polls"
  }
  ```

**Why Polls Critical:**
- Anonymous voting (Signal doesn't expose who voted what)
- Multiple choice options (better than binary reactions)
- Native Signal UX (familiar interface)
- Preserves privacy during sensitive decisions

**Constraints**: 
- Never store Signal IDs in cleartext, ephemeral memory (wipe immediately)
- Never persist message history (vetting conversations ephemeral only)
- Implement custom minimal ProtocolStore (NOT default SqliteStore)

**Server Seizure Protection:**

Default Presage SqliteStore stores ALL messages - this is a critical vulnerability.

**Required:** Custom StromaProtocolStore that stores ONLY Signal protocol state:
- Sessions (for encryption continuity)
- Pre-keys (for new conversations)
- Identity keys (bot's Signal identity)

**Forbidden:** Message history, contact database, conversation content

**See:** `.beads/security-constraints.bead` section 10, `.beads/technology-stack.bead`

#### Freenet Crates (Q1 Validated)

**`freenet` crate** — For running the node:
- **Entry Points**:
  - `freenet::dev_tool::SimNetwork` — Deterministic multi-node testing
  - `freenet::local_node::Executor::new_mock_in_memory()` — Unit testing
  - `freenet::local_node::NodeConfig::build()` — Production node
- **See**: [docs.rs/freenet](https://docs.rs/freenet/latest/freenet/)

**`freenet-stdlib` crate** — For writing Wasm contracts:
- **Trait**: `ContractInterface` (validate_state, update_state, summarize_state, get_state_delta)
- **Q1 Finding**: Delta operations MUST be commutative (contract's responsibility)
- **Pattern**: Set-based state (BTreeSet) with tombstones for remove-wins
- **Merkle Trees**: Generate on-demand from sets (not stored in contract)
- **See**: `docs/spike/q1/RESULTS.md` for validated patterns

### Storage & Caching

#### `sled`
- **Purpose**: Encrypted local cache (optional, for ephemeral state)
- **Usage**: Temporary state caching (never store cleartext IDs)
- **Requirement**: Must be encrypted, all data must be hashed
- **Ephemeral State**: Relationship data deleted after vetting threshold met
- **Constraint**: Freenet is source of truth, not local cache

## Build Requirements

### Static MUSL Binary
- **Requirement**: Must produce statically linked MUSL binary
- **Target**: `x86_64-unknown-linux-musl` or equivalent
- **Configuration**: Use `cross` or `cargo build --target` with musl toolchain
- **Rationale**: Minimal attack surface, no dynamic linking vulnerabilities

### Binary Size Monitoring
- **Requirement**: Monitor binary size in CI/CD
- **Tool**: Gastown Deacon or custom script
- **Action**: Alert on significant size increases (indicates dependency bloat)
- **Constraint**: Keep attack surface minimal

## Mandatory Tooling

### Supply Chain Security

#### `cargo-deny`
- **Purpose**: Dependency auditing
- **Requirement**: **Mandatory** in CI/CD pipeline
- **Usage**: Check for security vulnerabilities, license issues, duplicate dependencies
- **Configuration**: Must run before every merge

#### `cargo-crev`
- **Purpose**: Cryptographic verification of dependencies
- **Requirement**: **Mandatory** in CI/CD pipeline
- **Usage**: Verify crate authenticity and security reviews
- **Integration**: Part of Gastown CI/CD pipeline

### Testing Tooling

#### `cargo-nextest`
- **Purpose**: Test execution framework
- **Requirement**: Use for all test runs
- **Configuration**: See `testing-standards.mdc`
- **Usage**: `cargo nextest run` for deterministic test execution

#### Coverage Tools
- **Options**: `cargo-llvm-cov` or `cargo-tarpaulin`
- **Requirement**: Enforce 100% code coverage
- **Integration**: Generate coverage reports in CI/CD

### Development Tools

#### `rustfmt`
- **Purpose**: Code formatting
- **Requirement**: All code must be formatted
- **Usage**: Run automatically in pre-commit hooks

#### `clippy`
- **Purpose**: Linting and code quality
- **Requirement**: Fix all warnings before merging
- **Usage**: `cargo clippy -- -D warnings`

## Integration Patterns

### Signal Protocol Integration
- **Library**: `libsignal-service-rs`
- **Pattern**: 
  - Bot acts as Signal group admin
  - All vetting/vouching in 1-on-1 PMs (never group chat)
  - Monitor Freenet state stream for membership changes
  - Immediate ejection when trust threshold violated
- **Security**: Never log or store Signal IDs

### Freenet Integration (Q1 Validated)
- **Node Embedding**: `freenet` crate (NodeConfig::build() for production)
- **Contract Writing**: `freenet-stdlib` (ContractInterface trait)
- **Testing**: `freenet::dev_tool::SimNetwork` (deterministic, in-memory)
- **Pattern**:
  - Set-based state (BTreeSet) with tombstones — commutative merges
  - Merkle Trees generated on-demand (not stored in contract)
  - State stream monitoring for real-time updates
  - Emergent discovery via Social Anchor Hashing
- **Q1 Finding**: Delta commutativity is contract's responsibility
- **Security**: All operations preserve anonymity
- **See**: `docs/spike/q1/RESULTS.md`

### ZK-Proof Integration
- **Library**: `arkworks`
- **Pattern**:
  - Implement recursive proofs for scalability
  - Constant-time verification regardless of network size
  - Verify: `zk-Proof(Voucher IN Tree AND Hash_new NOT_IN Tree)`
- **Requirement**: All trust operations must use ZK-proofs

## Runtime Requirements

### Sandboxing (Production)
- **Tool**: seccomp
- **Requirement**: Production bot runs in restricted sandbox
- **Allowed**: Only Signal and Freenet node traffic
- **Blocked**: All other network access
- **Rationale**: Minimize attack surface

### Memory Safety
- **Requirement**: No `unsafe` blocks without security review
- **Tool**: `zeroize` for sensitive buffer cleanup
- **Pattern**: Zeroize immediately after cryptographic operations
- **Audit**: Review all `unsafe` usage in code review

## Dependency Management

### Version Pinning
- **Strategy**: Pin major versions, allow patch updates
- **Security**: Review all dependency updates for security implications
- **Tool**: `cargo update` with `cargo-deny` verification

### Dependency Bloat Prevention
- **Requirement**: Minimize dependencies
- **Monitoring**: Track binary size changes
- **Action**: Reject dependencies that add significant bloat
- **Preference**: Well-audited, minimal crates over convenience libraries

### Prohibited Dependencies
- ❌ **NEVER** use crates that require network access (except Signal/Freenet)
- ❌ **NEVER** use crates that log or expose identifiers
- ❌ **NEVER** use crates with known security vulnerabilities
- ❌ **NEVER** use crates that bypass zeroization requirements

## Build Configuration

### Cargo.toml Requirements
```toml
[package]
name = "stroma"
version = "0.1.0"
edition = "2021"

[dependencies]
ring = { version = "...", features = ["std"] }
zeroize = { version = "...", features = ["zeroize_derive"] }
arkworks = { version = "..." }
libsignal-service-rs = { version = "..." }
sled = { version = "...", optional = true }
freenet-scaffold = { version = "..." }

[dev-dependencies]
cargo-nextest = "..."
proptest = "..."  # For property-based testing
mock_instant = "..."  # For deterministic time mocking

[profile.release]
opt-level = "z"  # Optimize for size
lto = true  # Link-time optimization
strip = true  # Strip symbols
```

### Build Targets
- **Primary**: `x86_64-unknown-linux-musl` (static MUSL)
- **Development**: Native target for faster iteration
- **CI/CD**: Build and test on multiple targets

## Integration Guardrails

### Signal Integration Guardrails
- ✅ **DO**: Use 1-on-1 PMs for all vetting operations
- ✅ **DO**: Verify Freenet state before Signal actions
- ✅ **DO**: Execute immediate ejection when threshold violated
- ❌ **DON'T**: Store Signal IDs in any form
- ❌ **DON'T**: Expose operations in group chat
- ❌ **DON'T**: Make Signal group the source of truth

### Freenet Integration Guardrails (Q1 Validated)
- ✅ **DO**: Use `freenet` crate for node embedding (NodeConfig::build())
- ✅ **DO**: Use `freenet-stdlib` for contracts (ContractInterface trait)
- ✅ **DO**: Use set-based structures (BTreeSet, HashMap) for mergeability
- ✅ **DO**: Generate Merkle Trees on-demand (not stored in contract)
- ✅ **DO**: Implement summary-delta synchronization
- ✅ **DO**: Test delta commutativity (same result regardless of order)
- ✅ **DO**: Use tombstones for deletions (remove-wins semantics)
- ✅ **DO**: Apply removals before additions in apply_delta()
- ❌ **DON'T**: Store Merkle Trees as primary state (not mergeable)
- ❌ **DON'T**: Use Vec for state (order matters, not easily mergeable)
- ❌ **DON'T**: Expect Freenet to enforce commutativity (contract's job)
- ❌ **DON'T**: Expose member identities in contract state (use hashes)

### Cryptographic Guardrails
- ✅ **DO**: Use `ring` for all HMAC operations
- ✅ **DO**: Zeroize all sensitive buffers immediately
- ✅ **DO**: Use deterministic hashing for tests
- ❌ **DON'T**: Use non-audited cryptographic libraries
- ❌ **DON'T**: Skip zeroization of keys or identifiers
- ❌ **DON'T**: Use pre-shared keys for federation

## Tooling Integration

### CI/CD Pipeline Requirements
1. **Build**: Static MUSL binary
2. **Test**: `cargo nextest run` with 100% coverage
3. **Audit**: `cargo-deny check` and `cargo-crev verify`
4. **Lint**: `cargo clippy -- -D warnings`
5. **Format**: `cargo fmt --check`
6. **Size**: Monitor binary size (alert on increases)

### Pre-Commit Hooks
- Format code with `rustfmt`
- Run `cargo clippy` for warnings
- Run fast unit tests
- Check for `unsafe` blocks

### Gastown Integration
- **Beads**: Store tech stack constraints as Immutable Beads
- **Agents**: Each agent must respect tech stack requirements
- **Refinery**: Review for dependency bloat and security issues
- **Deacon**: Monitor build health and binary size

## Version Constraints

### Rust Version
- **Minimum**: Rust 1.93+ (released Jan 22, 2026)
- **Edition**: 2021
- **Rationale**: 
  - Bundled musl 1.2.5 with major DNS resolver improvements
  - More reliable networking for Signal and freenet-core
  - Better handling of large DNS records and recursive name servers
  - Security updates and modern features
- **Reference**: [Rust 1.93 Release](https://www.infoworld.com/article/4120988/rust-1-93-updates-bundled-musl-library-to-boost-networking.html)

### Dependency Versions
- **Strategy**: Pin to latest stable, audited versions
- **Updates**: Review all updates with `cargo-deny` and `cargo-crev`
- **Security**: Prioritize security patches

## Anti-Patterns (BLOCK)

### ❌ Prohibited Practices
- **NEVER** add dependencies without security review
- **NEVER** use dynamic linking (must be static MUSL)
- **NEVER** bypass supply chain security tools
- **NEVER** introduce dependencies that require network access (except Signal/Freenet)
- **NEVER** use unmaintained or unaudited cryptographic libraries
- **NEVER** skip zeroization in cryptographic code paths
- **NEVER** store cleartext identifiers in any dependency

### ❌ Prohibited Dependencies
- No logging frameworks that might leak identifiers
- No network libraries except Signal/Freenet integrations
- No database libraries (use Freenet for state)
- No convenience libraries that add significant bloat
- No unmaintained or security-vulnerable crates

## Migration & Updates

### Adding New Dependencies
1. **Justify**: Document why dependency is necessary
2. **Audit**: Run `cargo-deny` and `cargo-crev`
3. **Review**: Security review of dependency
4. **Test**: Verify no binary size bloat
5. **Document**: Update this file with usage patterns

### Updating Dependencies
1. **Check**: Review changelog for security fixes
2. **Audit**: Re-run `cargo-deny` and `cargo-crev`
3. **Test**: Full test suite must pass
4. **Verify**: Binary size hasn't increased significantly

## Documentation Requirements

### Dependency Documentation
- Document purpose of each dependency
- Document usage patterns and constraints
- Document security considerations
- Keep this file updated with all dependencies

### Integration Documentation
- Document Signal integration patterns
- Document Freenet contract patterns
- Document ZK-proof implementation patterns
- Document security guardrails for each integration
