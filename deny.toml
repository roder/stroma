# cargo-deny configuration for Stroma
# Supply chain security per security-constraints.bead ยง9

[advisories]
# Security vulnerability checks from RustSec database
# cargo-deny 0.19+ checks all vulnerabilities, yanked crates, unmaintained crates by default
# Use 'ignore' array to explicitly allow specific advisories if needed
db-path = "~/.cargo/advisory-db"
db-urls = ["https://github.com/rustsec/advisory-db"]

# Ignored unmaintained crate advisories (transitive dependencies)
# These are acknowledged and accepted until upstream crates migrate
ignore = [
    { id = "RUSTSEC-2025-0141", reason = "bincode unmaintained - used by libsignal, alternatives being evaluated" },
]

[licenses]
# License compliance checks
# In cargo-deny 0.19+, only licenses in the 'allow' list are permitted
# Everything else is denied by default (no need for explicit deny list)
confidence-threshold = 0.9

# Allowed licenses (permissive only, per security-constraints.bead)
allow = [
    "MIT",
    "Apache-2.0",
    "Apache-2.0 WITH LLVM-exception",
    "BSD-2-Clause",
    "BSD-3-Clause",
    "BSL-1.0",              # Boost Software License 1.0 (OSI approved, from xxhash-rust)
    "ISC",
    "Unicode-3.0",          # Unicode License v3 (OSI approved, from ICU crates)
    "CC0-1.0",              # Creative Commons Zero (public domain)
    "MPL-2.0",              # Mozilla Public License 2.0 (weak copyleft)
    "AGPL-3.0-or-later",    # Project license
]

# Per-crate license exceptions for essential dependencies
# CRITICAL: Signal libraries use AGPL (copyleft)
# These are core dependencies required for the protocol - policy decision needed
exceptions = [
    # Signal Protocol dependencies (AGPL-3.0-only)
    { allow = ["AGPL-3.0-only"], crate = "libsignal-account-keys" },
    { allow = ["AGPL-3.0-only"], crate = "libsignal-core" },
    { allow = ["AGPL-3.0-only"], crate = "libsignal-protocol" },
    { allow = ["AGPL-3.0-only"], crate = "libsignal-service" },
    { allow = ["AGPL-3.0-only"], crate = "signal-crypto" },
    { allow = ["AGPL-3.0-only"], crate = "zkgroup" },
    { allow = ["AGPL-3.0-only"], crate = "zkcredential" },
    { allow = ["AGPL-3.0-only"], crate = "poksho" },
    { allow = ["AGPL-3.0-only"], crate = "partial-default" },
    { allow = ["AGPL-3.0-only"], crate = "partial-default-derive" },
    { allow = ["AGPL-3.0-only"], crate = "spqr" },

    # Presage (Signal client library) - AGPL-3.0-only
    { allow = ["AGPL-3.0-only"], crate = "presage" },
]

# Clarifications for ambiguous licenses
[[licenses.clarify]]
name = "ring"
expression = "MIT AND ISC AND OpenSSL"
license-files = [
    { path = "LICENSE", hash = 0xbd0eed23 }
]

[licenses.private]
# Allow unlicensed private/internal crates
ignore = false
registries = []

[bans]
# Warn on multiple versions of same dependency
# Set to "deny" for stricter enforcement once dependency tree is consolidated
multiple-versions = "warn"

# Warn on wildcard dependencies (git deps with pinned revisions are acceptable)
# Git dependencies with rev/tag/branch specified are secure despite being flagged
wildcards = "warn"

# Allow certain crates when using deny-by-default mode (not currently used)
allow = []

# Skip certain crates from duplicate version checks
# These duplicates are from incompatible dependency requirements
# and cannot be easily resolved without upstream changes
skip = []

# Skip dependency trees
skip-tree = []

# Banned crates (prohibited by security policy)
deny = [
    # presage-store-sqlite stores ALL messages - server seizure risk
    # See security-constraints.bead ยง10
    { name = "presage-store-sqlite", reason = "Stores message history - prohibited by security-constraints.bead ยง10. Use custom StromaProtocolStore instead." },
]

# Note: chrono was previously banned in favor of time crate, but it's a transitive
# dependency from libsignal/presage. Consider migrating when upstream supports time.

# External default features
external-default-features = "allow"

[sources]
# Allowed dependency sources
unknown-registry = "deny"   # Only use known registries
unknown-git = "deny"        # Git dependencies must be explicitly allowed
allow-registry = ["https://github.com/rust-lang/crates.io-index"]

# Git dependencies must be explicitly listed here
allow-git = [
    "https://github.com/whisperfish/presage",
    "https://github.com/roder/libsignal-service-rs",
    "https://github.com/signalapp/curve25519-dalek",
    "https://github.com/signalapp/libsignal",
    "https://github.com/signalapp/SparsePostQuantumRatchet.git",
]

[output]
# Feature depth for inclusion graphs in diagnostics
feature-depth = 1

[graph]
# Dependency graph analysis
targets = [
    { triple = "x86_64-unknown-linux-gnu" },
    { triple = "x86_64-unknown-linux-musl" },
    { triple = "aarch64-unknown-linux-gnu" },
]

all-features = true
no-default-features = false
